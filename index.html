<!DOCTYPE html>
<html>
<head>
    <title>Home sweet home</title>
    <script
    src="https://code.jquery.com/jquery-1.11.3.min.js"
    integrity="sha256-7LkWEzqTdpEfELxcZZlS6wAx5Ff13zZ83lYO2/ujj7g="
    crossorigin="anonymous"></script>

    <script type="text/javascript">
        const params = {};
        let authToken;
        if (window.location.hash && window.location.hash.length > 1) {
            const hashParams = window.location.hash.substr(1).split('&');
            hashParams.forEach(param => {
              const [key, value] = param.split('=');
              params[key] = value;
          });
        }

        if (params.access_token) {
            authToken = params.access_token;
            console.log("authToken is: " + authToken);
        } else {
            console.log("Could not find authToken");
        }

        // console.log(window.location.hash);

        function getUserInfo() {
            if(window.location.hash) {
                $.ajax({
                    url: "https://api.mypurecloud.com/api/v2/users/me",
                    type: "GET",
                    beforeSend: function(xhr){xhr.setRequestHeader('Authorization', 'bearer ' + authToken);},
                    success: function(data) {
                        console.log(data);

                        // Populate HTML elements dynamically
                        var userName = document.getElementById('name');
                        userName.innerHTML = data.name;
                        var userState = document.getElementById('state');
                        userState.innerHTML = data.state;
                        var userImage = document.getElementById('image');
                        userImage.src = data.images[1].imageUri;
                    }
                });

                location.hash=''
            } else {
                var queryStringData = {
                    response_type : "token",
                    client_id : "12df5196-bdda-4fe0-8f75-dd1d6bdd8b67",
                    redirect_uri : "http://localhost:3000/index.html"
                }
                window.location.replace("https://login.mypurecloud.com/oauth/authorize?" + jQuery.param(queryStringData));
            }
        };

        // By calling the function above, we actively get the data from the API
        getUserInfo();
    </script>

</head>
<body>
    <h1>Welcome <span id="name"></span>! You've been successfully authenticated :)</h1>

    <div id="details">
        <p>Your state is: <span id="state"></span></p>
        <p>Your profile image is: <img id="image"></span></p>
    </div>
</body>
</html>